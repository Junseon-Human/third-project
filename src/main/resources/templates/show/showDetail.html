<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $(document).ready(function(){
            calculateTotalPrice();

            $("#count").change(function(){
                calculateTotalPrice();
            });
        });

        function calculateTotalPrice() {
            const count = $("#count").val();
            const price = $("#price").val();
            const totalPrice = count * price;
            $("#totalPrice").html(totalPrice + "원");
        }


        var IMP = window.IMP;

        function requestPay() {
            const count = $("#count").val();
            const price = $("#price").val();
            const totalPrice = count * price;
            const email = [[${member != null ? member.email : ''}]];
            const name = [[${member != null ? member.name : ''}]];
            console.log(email);
            console.log(name);

            IMP.init("imp23776017");
            IMP.request_pay(
                {
                    pg: "html5_inicis",		//KG이니시스 pg파라미터 값
                    pay_method: "card",		//결제 방법
                    merchant_uid: generateOrderNumber(),//주문번호
                    name: `[[${show.prfnm}]]`,		//상품 명
                    amount: 100,			//금액
                    buyer_email: email,
                    buyer_name: name

                },
                function (rsp) {
                    //rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단합니다.
                    if (rsp.success) {
                        const token = $("meta[name='_csrf']").attr("content");
                        const header = $("meta[name='_csrf_header']").attr("content");

                        const url = "/order";

                        // 객체로 생성
                        const paramData = { showNum : $("#showNum").val(),
                            count : $("#count").val()};
                        // 객체를 JSON으로 변환
                        const param = JSON.stringify(paramData);

                        $.ajax({
                            url : url,
                            type : "POST",
                            /* 서버에게 보내는 데이터 타입 */
                            contentType : "application/json",
                            data : param,
                            beforeSend : function(xhr) {
                                /* 데이터를 전송하기 전에 헤더에 csrf 값을 설정 */
                                xhr.setRequestHeader(header, token)
                            },
                            /* 서버에게 결과값으로 받을 데이터 타입 */
                            dataType : "json",
                            cache : false,
                            success : function(result, status) {
                                alert("주문이 완료되었습니다.");
                                location.href='/orders';
                            },
                            error : function(xhr, status, error) {
                                if(xhr.status == '401') {
                                    alert("로그인 후 주문해주세요")
                                    location.href="/members/login";
                                } else {
                                    alert(xhr.responseText)
                                }
                            }
                        })
                    } else {
                        alert(rsp.error_msg);
                    }
                }
            );
        }

        function generateOrderNumber() {
            // 오늘 날짜를 YYYYMMDD 형식으로 가져오기
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 1월은 0이므로 +1
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = `${year}${month}${day}`; // YYYYMMDD 형식

            // 000부터 999까지의 랜덤 숫자 생성
            const randomNumber = String(Math.floor(Math.random() * 1000)).padStart(3, '0'); // 3자리로 맞추기

            // 주문번호 생성
            const orderNumber = `${dateString}${randomNumber}`;
            return orderNumber;
        }

        $(document).ready(function(){
            $('#review-form').on('submit', function(event){
                event.preventDefault();
                createReview(); //리뷰 생성 함수
            });
        });

        //후기 추가
        function createReview(){
            const mt20id = [[${mt20id}]]; //현재 페이지 공연아이디
            const reviewRating = document.getElementById('review-rating').value;
            const reviewContent = document.getElementById('review-content').value;
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const memberId = [[${memberId}]]; //현재 로그인 회원 아이디

            $.ajax({
                url: `/show/${mt20id}/review`,
                type: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                data: JSON.stringify({
                    rating: reviewRating,
                    content: reviewContent
                }),
                contentType: 'application/json',
                success: function (data){
                    const reviewList = document.getElementById('review-list');
                    if(!reviewList){
                        console.error("후기 리스트를 찾을 수 없습니다");
                        return;
                    }
                    const newReview = document.createElement('li');
                    newReview.className = 'list-group-item';
                    newReview.id = 'review-' + data.num;
                    newReview.innerHTML = `
                        <p id="'rating-' + ${data.num}">${data.rating}</p>
                        <p id="'content-' + ${data.num}">${data.content}</p>
                        <span>
                            <span style="font-size: small">${data.memberId}</span>
                            <span style="font-size: small" >${data.createDate}</span>&nbsp;
                            <div>
                                <button type="button" class="badge bi bi-pencil-square"
                                        data-id="${data.num}" onclick="updateReview(this)">수정</button>
                                <button type="button" class="badge bi bi-trash"
                                        data-id="${data.num}" onclick="deleteReview(this)">삭제</button>
                            </div>
                        </span>
                    `;
                    reviewList.appendChild(newReview);
                    document.getElementById('review-content').value = '';
                    alert("후기가 작성됐습니다");
                },
                error: function (xhr){
                    console.log("error : ", xhr);
                    alert("error : " + xhr.statusText);
                }
            });
        }

        //후기 수정
        // function updateReview(button){
        //     const mt20id = [[${mt20id}]];
        //     const reviewId = button.getAttribute('data-id');
        //     const reviewRatingId = document.getElementById('rating-' + reviewId); //평점
        //     const reviewContentId = document.getElementById('content-' + reviewId); //내용
        //
        //     if(!reviewContentId){
        //         console.log("후기 내용을 찾을 수 없습니다");
        //         return;
        //     }
        //
        //     const newRating = reviewRatingId.textContent;
        //     const reviewContent = reviewContentId.textContent;
        //     const
        // }

    </script>
</th:block>


<div layout:fragment="content">
    <input type="hidden" id="showNum" th:value="${show.mt20id}">
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=35267baa78fc79afc7626fc0349548fe"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>


    <div class="container">
        <div class="d-flex">
            <div class="wd50">

                <div class="text-right" th:if="${show.ticketStatus == T(com.keduit.show.constant.TicketStatus).SELL}">
                    <hr class="my-4">
                    <div class="text-right">
                        <div class="h4 text-danger text-left">
                            <input type="hidden" th:value="${show.pcseguidance}" id="price" name="price">
                            <span th:text="${show.pcseguidance}"></span> 원

                        </div>
                        <div class="input-group w-50">
                            <div class="input-group-prepend">
                        <span class="input-group-text">
                            수량
                        </span>
                            </div>
                            <input type="number" class="form-control" name="count" id="count" value="1" min="1">
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="text-right mgt-50">
                        <h5>결제금액</h5>
                        <h3 class="font-weight-bold" name="totalPrice" id="totalPrice"></h3>
                    </div>
                    <button type="button" class="btn btn-primary btn-lg" onclick="requestPay()">예매하기</button>
                </div>
                <div class="text-right"
                     th:if="${show.ticketStatus == T(com.keduit.show.constant.TicketStatus).SOLD_OUT}">
                    <button type="button" class="btn btn-danger btn-lg">매진</button>
                </div>
            </div>
        </div>

        <input type="hidden" id="showDetail" th:value="${show.mt20id}">
        <h1 th:text="${show.prfnm}"></h1>

        <!--공연상태-->
        <div th:switch="${show.prfstate.name()}">
            <span th:case="'EXPECT'" class="badge bg-primary">공연예정</span>
            <span th:case="'ING'" class="badge bg-success">공연중</span>
            <span th:case="'COMPLETE'" class="badge bg-secondary">공연완료</span>
        </div>

        <div class="d-flex">
            <div class="poster">
                <img th:src="${show.poster}" class="img-fluid rounded-start" th:alt="${show.prfnm}">
            </div>

            <!--즐겨찾기-->
            <form th:action="@{/favorite}" th:method="post" onsubmit="return checkLogin();">
                <input type="hidden" name="mt20id" th:value="${show.mt20id}">
                <input type="hidden" name="isLogin" th:value="${isLogin}">
                <button type="submit" class="btn" th:classappend="${favoriteShow}">즐겨찾기</button>
                <h4 th:text="${show.likeCount}"></h4>
            </form>

            <div class="table">
                <table class="table">
                    <tbody>
                    <tr>
                        <th scope="row">공연장소</th>
                        <td th:text="${show.fcltynm}"></td>
                    </tr>
                    <tr>
                        <th scope="row">공연기간</th>
                        <td th:text="${show.prfpdfrom} + '~' + ${show.prfpdto}"></td>
                    </tr>
                    <tr>
                        <th scope="row">관람시간</th>
                        <td th:text="${show.prfruntime}"></td>
                    </tr>
                    <tr>
                        <th scope="row">관람연령</th>
                        <td th:text="${show.prfage}"></td>
                    </tr>
                    <tr>
                        <th scope="row">가격</th>
                        <td th:text="|${show.pcseguidance}원|"></td>
                    </tr>
                    <tr>
                        <th scope="row">잔여티켓수량</th>
                        <td th:if="${show.getTicket() == 0}" th:text="매진"></td>
                        <td th:unless="${show.getTicket() == 0}" th:text="${show.getTicket()} + '매'"></td>
                    </tr>
                    <tr>
                        <th scope="row">출연진</th>
                        <td th:text="${show.prfcast}"></td>
                    </tr>
                    <tr>
                        <th scope="row">제작진</th>
                        <td th:text="${show.prfcrew}"></td>
                    </tr>
                    <tr>
                        <th scope="row">기획사</th>
                        <td th:text="${show.entrpsnm}"></td>
                    </tr>
                    <tr>
                        <th scope="row">주최</th>
                        <td th:text="${show.entrpsnmH}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <img th:src="${show.styurl}" class="img-fluid rounded-start" th:alt="${show.prfnm}">
        </div>

        <!--장소 지도 띄우기-->
        <input type="hidden" name="la" th:value="${showFacility.la}">
        <input type="hidden" name="lo" th:value="${showFacility.lo}">
        <input type="hidden" name="fcltynm" th:value="${show.fcltynm}">
        <input type="hidden" name="adres" th:value="${showFacility.adres}">
        <h3 th:text="${showFacility.adres}"></h3>
        <div id="map" style="width: 500px; height: 400px;"></div>


        <!--공연후기 작성 폼 createReview()으로 실행-->
        <div class="card">
            <div class="card-header bi bi-chat-right-dots">후기를 작성해 주세요</div>
            <form id="review-form">
                <!--로그인이 되어잇을 경우-->
                <div th:if="${isLogin} == true">
                    <div class="card-body">
                        <input name="review" type="number" id="review-rating" class="form-control" min="0" max="10" placeholder="평점을 입력하세요">
                        <textarea name="review" id="review-content" class="form-control" placeholder="후기를 입력하세요"></textarea>
                    </div>
                    <button type="submit" id="review-save-btn" class="btn btn-outline-primary bi bi-pencil-square">등록</button>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </div>
                <!--로그인이 안되어 잇는 경우-->
                <div th:unless="${isLogin} == true">
                    <div class="card-body" style="font-size: small">
                        로그인 후 이용가능 합니다
                    </div>
                </div>
            </form>
        </div>

        <!--공연후기 리스트-->
        <div class="card" id="review-list">
            <div class="card-header bi bi-chat-dots" >Reviews</div>
            <ul class="list-group-flush">
                <th:block th:each="review : ${reviews}">
                    <li class="list-group-item" th:id="'review-' + ${review.getNum()}">
                        <p th:text="${review.getRating()}" th:id="'rating-' + ${review.getNum()}">평점</p>
                        <p th:text="${review.getContent()}" th:id="'content-' + ${review.getNum()}">내용</p>
                        <span>
                            <span style="font-size: small" th:text="${review.getMemberId()}">작성자아이디</span>
                            <span style="font-size: small" th:text="${review.getCreateDate()}">작성일</span>&nbsp;
                            <div th:if="${review.getMemberId() == memberId}">
                                <button type="button" class="badge bi bi-pencil-square"
                                        th:attr="data-id=${review.getNum()}" onclick="updateReview(this)">수정</button>
                                <button type="button" class="badge bi bi-trash"
                                        th:attr="data-id=${review.getNum()}" onclick="deleteReview(this)">삭제</button>
                            </div>
                        </span>
                    </li>
                </th:block>
            </ul>
        </div>

    </div>

    <script>
        //즐겨찾기 로그인체크
        const isLogin = $('input[name=isLogin]').val();
        console.log("로그인여부" + isLogin);
        function checkLogin(){
            if(!isLogin){
                alert("로그인 후 이용해주세요");
                return false;
            }
            return true;
        }
        //즐겨찾기 추가, 취소 alert
        let favoriteShow = document.getElementsByClassName('btn-primary')

        let container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
        let la = $('input[name=la]').val();
        let lo = $('input[name=lo]').val();
        let options = { //지도를 생성할 때 필요한 기본 옵션
            center: new kakao.maps.LatLng(la, lo), //지도의 중심좌표.
            level: 3 //지도의 레벨(확대, 축소 정도)
        };
        let map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

        var markerPosition = new kakao.maps.LatLng(la, lo);  // 마커가 표시될 위치
        var marker = new kakao.maps.Marker({  // 마커 생성
            position: markerPosition
        });
        marker.setMap(map);

        // 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성
        //위치정보 길찾기로 넘기기
        var iwContent = '<div style="padding:5px;">' + $('input[name=fcltynm]').val() +
                '<br> <a href="https://map.kakao.com/link/to/' + $('input[name=adres]').val() +
                ',' + la + ',' + lo + '" style="color:blue" target="_blank">길찾기</a></div>',
            iwPosition = new kakao.maps.LatLng(la, lo),
            iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다

        var infowindow = new kakao.maps.InfoWindow({
            content: iwContent,
            position: iwPosition,
            removable: iwRemoveable
        });

        kakao.maps.event.addListener(marker, 'click', function () {
            infowindow.open(map, marker);
        });
    </script>


</div>
</html>